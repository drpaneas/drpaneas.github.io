<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title>Let's talk with a bit of theory</title>
<style type="text/css">

/* Minimal style sheet for the HTML output of Docutils.                    */
/*                                                                         */
/* :Author: Günter Milde, based on html4css1.css by David Goodger          */
/* :Id: $Id: minimal.css 7952 2016-07-26 18:15:59Z milde $               */
/* :Copyright: © 2015 Günter Milde.                                        */
/* :License: Released under the terms of the `2-Clause BSD license`_,      */
/*    in short:                                                            */
/*                                                                         */
/*    Copying and distribution of this file, with or without modification, */
/*    are permitted in any medium without royalty provided the copyright   */
/*    notice and this notice are preserved.                                */
/*                                                                         */
/*    This file is offered as-is, without any warranty.                    */
/*                                                                         */
/* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause     */

/* This CSS2.1_ stylesheet defines rules for Docutils elements without    */
/* HTML equivalent. It is required to make the document semantic visible. */
/*                                                                        */
/* .. _CSS2.1: http://www.w3.org/TR/CSS2                                  */
/* .. _validates: http://jigsaw.w3.org/css-validator/validator$link       */

/* "page layout" */
div.document {
    line-height:1.3;
    counter-reset: table;
    /* counter-reset: figure; */
    /* avoid long lines --> better reading */
    /* OTOH: lines should not be too short because of missing hyphenation, */
    max-width: 50em;
    margin: auto;
}

body {
    background-color: #151427;
    color: #DDECEC; 
    font-size: medium;
    font-family: 'salata';
    padding: 0 5%;
    margin: 8px 0;
}

p {
    max-width: 640px;
    word-wrap:break-word;
}

b, strong {
    color: #FF2B27;
}

i, em, italic {
    color: #FF8900;
}

h1, h2, h3, h4, h5 {
    color: #3AE25C; 
    font-family: 'salata';
}

@font-face {
    font-family: 'salata';
    src: url('https://raw.githubusercontent.com/drpaneas/drpaneas.github.io/master/salata.ttf') format('truetype');
}

/* alignment of text and inline objects inside block objects*/
.align-left   { text-align: left; }
.align-right  { text-align: right; }
.align-center { clear: both; text-align: center; }
.align-top    { vertical-align: top; }
.align-middle { vertical-align: middle; }
.align-bottom { vertical-align: bottom; }

/* titles */
h1.title, p.subtitle {
  text-align: center;
}
p.admonition-title,
p.topic-title,
p.sidebar-title,
p.rubric,
p.system-message-title {
  font-weight: bold;
}
h1 + p.subtitle,
h1 + p.section-subtitle {
  font-size: 1.6em;
}
h2 + p.section-subtitle { font-size: 1.28em; }
p.subtitle,
p.section-subtitle,
p.sidebar-subtitle {
  font-weight: bold;
  margin-top: -0.5em;
}
p.sidebar-title,
p.rubric {
  font-size: larger;
}
p.rubric { color: maroon; }
a.toc-backref {
  color: black;
  text-decoration: none; }

/* Warnings, Errors */
div.caution p.admonition-title,
div.attention p.admonition-title,
div.danger p.admonition-title,
div.error p.admonition-title,
div.warning p.admonition-title,
div.system-messages h1,
div.error,
span.problematic,
p.system-message-title {
  color: red;
}

/* inline literals */
span.docutils.literal {
  font-family: monospace;
  white-space: pre-wrap;
}
/* do not wraph at hyphens and similar: */
.literal > span.pre { white-space: nowrap; }

/* Lists */

/* compact and simple lists: no margin between items */
.simple  li, .compact li,
.simple  ul, .compact ul,
.simple  ol, .compact ol,
.simple > li p, .compact > li p,
dl.simple > dd, dl.compact > dd {
  margin-top: 0;
  margin-bottom: 0;
}

/* Table of Contents */
div.topic.contents { margin: 0; }
ul.auto-toc {
  list-style-type: none;
  padding-left: 1.5em; }

/* Enumerated Lists */
ol.arabic     { list-style: decimal }
ol.loweralpha { list-style: lower-alpha }
ol.upperalpha { list-style: upper-alpha }
ol.lowerroman { list-style: lower-roman }
ol.upperroman { list-style: upper-roman }

dt span.classifier { font-style: italic }
dt span.classifier:before {
  font-style: normal;
  margin: 0.5em;
  content: ":";
}

/* Field Lists and drivatives */
/* bold field name, content starts on the same line */
dl.field-list > dt,
dl.option-list > dt,
dl.docinfo > dt,
dl.footnote > dt,
dl.citation > dt {
  font-weight: bold;
  clear: left;
  float: left;
  margin: 0;
  padding: 0;
  padding-right: 0.5em;
}
/* Offset for field content (corresponds to the --field-name-limit option) */
dl.field-list > dd,
dl.option-list > dd,
dl.docinfo > dd {
  margin-left:  9em; /* ca. 14 chars in the test examples */
}
/* start field-body on a new line after long field names */
dl.field-list > dd > *:first-child,
dl.option-list > dd > *:first-child
{
  display: inline-block;
  width: 100%;
  margin: 0;
}
/* field names followed by a colon */
dl.field-list > dt:after,
dl.docinfo > dt:after {
  content: ":";
}

/* Bibliographic Fields (docinfo) */
pre.address { font: inherit; }
dd.authors > p { margin: 0; }

/* Option Lists */
dl.option-list { margin-left: 40px; }
dl.option-list > dt { font-weight: normal; }
span.option { white-space: nowrap; }

/* Footnotes and Citations  */
dl.footnote.superscript > dd {margin-left: 1em; }
dl.footnote.brackets > dd {margin-left: 2em; }
dl > dt.label { font-weight: normal; }
a.footnote-reference.brackets:before,
dt.label > span.brackets:before { content: "["; }
a.footnote-reference.brackets:after,
dt.label > span.brackets:after { content: "]"; }
a.footnote-reference.superscript,
dl.footnote.superscript > dt.label {
  vertical-align: super;
  font-size: smaller;
}
dt.label > span.fn-backref { margin-left: 0.2em; }
dt.label > span.fn-backref > a { font-style: italic; }

/* Line Blocks */
div.line-block { display: block; }
div.line-block div.line-block {
  margin-top: 0;
  margin-bottom: 0;
  margin-left: 40px;
}

/* Figures, Images, and Tables */
.figure.align-left,
img.align-left,
object.align-left,
table.align-left {
  margin-right: auto;
}
.figure.align-center,
img.align-center,
object.align-center {
  margin-left: auto;
  margin-right: auto;
  display: block;
}
table.align-center {
  margin-left: auto;
  margin-right: auto;
}
.figure.align-right,
img.align-right,
object.align-right,
table.align-right {
  margin-left: auto;
}
/* reset inner alignment in figures and tables */
div.align-left, div.align-center, div.align-right,
table.align-left, table.align-center, table.align-right
{ text-align: inherit }

/* Admonitions and System Messages */
div.admonition,
div.system-message,
div.sidebar{
  margin: 40px;
  border: medium outset;
  padding-right: 1em;
  padding-left: 1em;
}

/* Sidebar */
div.sidebar {
  width: 30%;
  max-width: 26em;
  float: right;
  clear: right;
}

/* Text Blocks */
div.topic,
pre.literal-block,
pre.doctest-block,
pre.math,
pre.code {
  margin-right: 40px;
  margin-left: 40px;
}
pre.code .ln { color: gray; } /* line numbers */

/* Tables */
table { border-collapse: collapse; }
td, th {
  border-style: solid;
  border-color: silver;
  padding: 0 1ex;
  border-width: thin;
}
td > p:first-child, th > p:first-child { margin-top: 0; }
td > p, th > p { margin-bottom: 0; }

table > caption {
  text-align: left;
  margin-bottom: 0.25em
}

table.borderless td, table.borderless th {
  border: 0;
  padding: 0;
  padding-right: 0.5em /* separate table cells */
}

</style>
<style type="text/css">

pre.code .hll { background-color: #333333 }
pre.code  { background: #111111; color: #ffffff; font-family: 'monaco'; font-size: medium; }
pre.code .c { color: #008800; font-style: italic; background-color: #0f140f } /* Comment */
pre.code .err { color: #ffffff } /* Error */
pre.code .esc { color: #ffffff } /* Escape */
pre.code .g { color: #ffffff } /* Generic */
pre.code .k { color: #fb660a; font-weight: bold } /* Keyword */
pre.code .l { color: #ffffff } /* Literal */
pre.code .n { color: #ffffff } /* Name */
pre.code .o { color: #ffffff } /* Operator */
pre.code .x { color: #ffffff } /* Other */
pre.code .p { color: #ffffff } /* Punctuation */
pre.code .ch { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Hashbang */
pre.code .cm { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Multiline */
pre.code .cp { color: #ff0007; font-weight: bold; font-style: italic; background-color: #0f140f } /* Comment.Preproc */
pre.code .cpf { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.PreprocFile */
pre.code .c1 { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Single */
pre.code .cs { color: #008800; font-style: italic; background-color: #0f140f } /* Comment.Special */
pre.code .gd { color: #ffffff } /* Generic.Deleted */
pre.code .ge { color: #ffffff } /* Generic.Emph */
pre.code .gr { color: #ffffff } /* Generic.Error */
pre.code .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
pre.code .gi { color: #ffffff } /* Generic.Inserted */
pre.code .go { color: #444444; background-color: #222222 } /* Generic.Output */
pre.code .gp { color: #ffffff } /* Generic.Prompt */
pre.code .gs { color: #ffffff } /* Generic.Strong */
pre.code .gu { color: #ffffff; font-weight: bold } /* Generic.Subheading */
pre.code .gt { color: #ffffff } /* Generic.Traceback */
pre.code .kc { color: #fb660a; font-weight: bold } /* Keyword.Constant */
pre.code .kd { color: #fb660a; font-weight: bold } /* Keyword.Declaration */
pre.code .kn { color: #fb660a; font-weight: bold } /* Keyword.Namespace */
pre.code .kp { color: #fb660a } /* Keyword.Pseudo */
pre.code .kr { color: #fb660a; font-weight: bold } /* Keyword.Reserved */
pre.code .kt { color: #cdcaa9; font-weight: bold } /* Keyword.Type */
pre.code .ld { color: #ffffff } /* Literal.Date */
pre.code .m { color: #0086f7; font-weight: bold } /* Literal.Number */
pre.code .s { color: #0086d2 } /* Literal.String */
pre.code .na { color: #ff0086; font-weight: bold } /* Name.Attribute */
pre.code .nb { color: #ffffff } /* Name.Builtin */
pre.code .nc { color: #ffffff } /* Name.Class */
pre.code .no { color: #0086d2 } /* Name.Constant */
pre.code .nd { color: #ffffff } /* Name.Decorator */
pre.code .ni { color: #ffffff } /* Name.Entity */
pre.code .ne { color: #ffffff } /* Name.Exception */
pre.code .nf { color: #ff0086; font-weight: bold } /* Name.Function */
pre.code .nl { color: #ffffff } /* Name.Label */
pre.code .nn { color: #ffffff } /* Name.Namespace */
pre.code .nx { color: #ffffff } /* Name.Other */
pre.code .py { color: #ffffff } /* Name.Property */
pre.code .nt { color: #fb660a; font-weight: bold } /* Name.Tag */
pre.code .nv { color: #fb660a } /* Name.Variable */
pre.code .ow { color: #ffffff } /* Operator.Word */
pre.code .w { color: #888888 } /* Text.Whitespace */
pre.code .mb { color: #0086f7; font-weight: bold } /* Literal.Number.Bin */
pre.code .mf { color: #0086f7; font-weight: bold } /* Literal.Number.Float */
pre.code .mh { color: #0086f7; font-weight: bold } /* Literal.Number.Hex */
pre.code .mi { color: #0086f7; font-weight: bold } /* Literal.Number.Integer */
pre.code .mo { color: #0086f7; font-weight: bold } /* Literal.Number.Oct */
pre.code .sa { color: #0086d2 } /* Literal.String.Affix */
pre.code .sb { color: #0086d2 } /* Literal.String.Backtick */
pre.code .sc { color: #0086d2 } /* Literal.String.Char */
pre.code .dl { color: #0086d2 } /* Literal.String.Delimiter */
pre.code .sd { color: #0086d2 } /* Literal.String.Doc */
pre.code .s2 { color: #0086d2 } /* Literal.String.Double */
pre.code .se { color: #0086d2 } /* Literal.String.Escape */
pre.code .sh { color: #0086d2 } /* Literal.String.Heredoc */
pre.code .si { color: #0086d2 } /* Literal.String.Interpol */
pre.code .sx { color: #0086d2 } /* Literal.String.Other */
pre.code .sr { color: #0086d2 } /* Literal.String.Regex */
pre.code .s1 { color: #0086d2 } /* Literal.String.Single */
pre.code .ss { color: #0086d2 } /* Literal.String.Symbol */
pre.code .bp { color: #ffffff } /* Name.Builtin.Pseudo */
pre.code .fm { color: #ff0086; font-weight: bold } /* Name.Function.Magic */
pre.code .vc { color: #fb660a } /* Name.Variable.Class */
pre.code .vg { color: #fb660a } /* Name.Variable.Global */
pre.code .vi { color: #fb660a } /* Name.Variable.Instance */
pre.code .vm { color: #fb660a } /* Name.Variable.Magic */
pre.code .il { color: #0086f7; font-weight: bold } /* Literal.Number.Integer.Long */ 
@font-face {
    font-family: 'monaco';
    src: url('monaco.ttf') format('truetype');
}

</style>
</head>
<body>
<div class="document" id="let-s-talk-with-a-bit-of-theory">
<h1 class="title">Let's talk with a bit of theory</h1>

<p>Deep (down) inside the Linux Kernel, there's a framework called <strong>netfilter</strong>.
Every IP packet that flows through the machine is subjected to critical
examination by Netfiler. It basically observes:</p>
<ul class="simple">
<li><p>Source IP Address of the packet</p></li>
<li><p>Destination IP Address of the packet</p></li>
<li><p>The overlying protocol (UDP or TCP)</p></li>
<li><p>Source Port</p></li>
<li><p>Destination Port</p></li>
<li><p>From which Network Interface the packet came in</p></li>
<li><p>To which Network Interface the packet is going out</p></li>
<li><p>Other stuff (e.g. TCP flags, TCP Headers)</p></li>
</ul>
<p>Based on the examination, there's a set of rules we define, so <em>Netfilter</em>
decides either to accept a packet, meaning to allow it to pass or to drop it.
This filtering occurs as the number of places the packet flows inside the
machine. For example:</p>
<p>Let's say we have a packet coming in. The first that happens is a routing
decision: Is the packet destined for the local machine, or not? If it does, then
it passes through the <strong>INPUT</strong> chain, where we keep a list of filtering rules.
Assuming that the package complies with the list of rules, it survives our
filtering and passes onto a <strong>local process</strong>, presumably listening on a TCP/UDP
port.</p>
<p>If the packet is destined for another machine, it will pass through the
<strong>FORWARD chain</strong>, and then into another list of filtering rules and last gets
transmitted back to the network. If the packet originates on the local machine,
it will pass through the <strong>OUTPUT chain</strong>, before being send out to the network.</p>
<p>A chain, is basically a list of rules. Each rule is consisted of a pattern and
an associated action. This looks like a stack of rules, that order matters. So,
the first rule that gets matched, determines the fate of the packet, meaning
that an associated action will be applied on it. An associated action normaly is
either accept or drop the packet. However, if the packet doesn't match any rule
and makes its way down to the end of the chain, then there's a policy that it's
also applied on that chain, so a default action will be taken. All of these
rules are down inside the kernel, but in <strong>userspace</strong> there's a command-line
tool, called <strong>iptables</strong> that's responsible for managing these rules in the
kernel. And essentially, what we are going to do in this tutorial is to create
a very simply shell script containing iptables' commands that will allow our
machine to operate as a simple firewall.</p>
<div class="section" id="setup">
<h1>Setup</h1>
<p>The setup we are using for this demo, is a <strong>Server machine</strong> which runs SSH
Server, Web Server and a couple of other things. From the other hand, I have a
client machine that will allow me to observe the server machine from outside.
Also, just to make our life a little less confusing, we are going to use pink
color for the terminal in the server machine, and green color for the client
one.</p>
<div class="section" id="look-at-the-current-ruleset">
<h2>Look at the current ruleset</h2>
<p>Let's start by going to the server machine and looking and the current ruleset.</p>
<pre class="code bash literal-block"><code><span class="c1"># iptables -L</span></code></pre>
<pre class="code bash literal-block"><code>Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination</code></pre>
<p>What we see here is that no matter of the chains, there are no rules at the
moment being specified. Also, in each of the chains, the default policy is to
ACCEPT the packet. So, currently everything is allowed to flow in, without any
kind of filtering taking place.</p>
<p>So, let's go now to our client machine and try to do an SSH login.</p>
<pre class="code bash literal-block"><code>ssh root&#64;server</code></pre>
<p>As you can see, we were able to connect via SSH into the machine as a proof that
nothing prevented us from doing it so. Apart from SSH, there's also another tool
we case use, called nmap. Nmap is a port-scanner and can tell us which port is
open and which port is closed on the server. So, let's do a port scann of the
server:</p>
<pre class="code bash literal-block"><code>nmap -PN server

Starting Nmap <span class="m">6</span>.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at <span class="m">2016</span>-11-28 <span class="m">23</span>:40 CET
Nmap scan report <span class="k">for</span> localhost <span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span>
Host is up <span class="o">(</span><span class="m">0</span>.000017s latency<span class="o">)</span>.
Not shown: <span class="m">996</span> closed ports
PORT    STATE SERVICE
<span class="m">22</span>/tcp  open  ssh
<span class="m">25</span>/tcp  open  smtp
<span class="m">80</span>/tcp  open  http
<span class="m">111</span>/tcp open  rpcbind
<span class="m">631</span>/tcp open  ipp</code></pre>
</div>
</div>
</div>
</body>
</html>
