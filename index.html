<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta charset="utf-8"/>
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title>Let's talk with a bit of theory</title>
<style type="text/css">

body {
     background-color: #1C1F27; 
    color: #DDECEC;
    font-size: medium;
    font-family: 'salata';
}

a {
    color: #1e8eff;
}

p {
    max-width: 640px;
    word-wrap:break-word;
}

b, strong {
    color: #ff8e1e;
    /*color: #FF2B27;*/
}

i, em, italic {
    color: #1eff8e;
}

h1, h2, h3, h4, h5 {
    font-family: 'salata';
    color: #8eff1e; 
}

@font-face {
    font-family: 'salata';
    src: url('salata.ttf') format('truetype');
}

pre, xmp, plaintext, listing {
    border-radius: 10px;
    display: inline-block;
    display: inline-block;
    margin-top: 5px;
    margin-left: 25px;
    margin-bottom: 5px;
}

</style>
<style type="text/css">

pre.code .hll { background-color: #4f424c }
pre.code  { background: #14191f ; color: #e7e9db }
pre.code .c { color: #776e71 } /* Comment */
pre.code .err { color: #ef6155 } /* Error */
pre.code .k { color: #815ba4 } /* Keyword */
pre.code .l { color: #f99b15 } /* Literal */
pre.code .n { color: #e7e9db } /* Name */
pre.code .o { color: #5bc4bf } /* Operator */
pre.code .p { color: #e7e9db } /* Punctuation */
pre.code .ch { color: #776e71 } /* Comment.Hashbang */
pre.code .cm { color: #776e71 } /* Comment.Multiline */
pre.code .cp { color: #776e71 } /* Comment.Preproc */
pre.code .cpf { color: #776e71 } /* Comment.PreprocFile */
pre.code .c1 { color: #776e71 } /* Comment.Single */
pre.code .cs { color: #776e71 } /* Comment.Special */
pre.code .gd { color: #ef6155 } /* Generic.Deleted */
pre.code .ge { font-style: italic } /* Generic.Emph */
pre.code .gh { color: #e7e9db; font-weight: bold } /* Generic.Heading */
pre.code .gi { color: #48b685 } /* Generic.Inserted */
pre.code .gp { color: #776e71; font-weight: bold } /* Generic.Prompt */
pre.code .gs { font-weight: bold } /* Generic.Strong */
pre.code .gu { color: #5bc4bf; font-weight: bold } /* Generic.Subheading */
pre.code .kc { color: #815ba4 } /* Keyword.Constant */
pre.code .kd { color: #815ba4 } /* Keyword.Declaration */
pre.code .kn { color: #5bc4bf } /* Keyword.Namespace */
pre.code .kp { color: #815ba4 } /* Keyword.Pseudo */
pre.code .kr { color: #815ba4 } /* Keyword.Reserved */
pre.code .kt { color: #fec418 } /* Keyword.Type */
pre.code .ld { color: #48b685 } /* Literal.Date */
pre.code .m { color: #f99b15 } /* Literal.Number */
pre.code .s { color: #48b685 } /* Literal.String */
pre.code .na { color: #06b6ef } /* Name.Attribute */
pre.code .nb { color: #e7e9db } /* Name.Builtin */
pre.code .nc { color: #fec418 } /* Name.Class */
pre.code .no { color: #ef6155 } /* Name.Constant */
pre.code .nd { color: #5bc4bf } /* Name.Decorator */
pre.code .ni { color: #e7e9db } /* Name.Entity */
pre.code .ne { color: #ef6155 } /* Name.Exception */
pre.code .nf { color: #06b6ef } /* Name.Function */
pre.code .nl { color: #e7e9db } /* Name.Label */
pre.code .nn { color: #fec418 } /* Name.Namespace */
pre.code .nx { color: #06b6ef } /* Name.Other */
pre.code .py { color: #e7e9db } /* Name.Property */
pre.code .nt { color: #5bc4bf } /* Name.Tag */
pre.code .nv { color: #ef6155 } /* Name.Variable */
pre.code .ow { color: #5bc4bf } /* Operator.Word */
pre.code .w { color: #e7e9db } /* Text.Whitespace */
pre.code .mb { color: #f99b15 } /* Literal.Number.Bin */
pre.code .mf { color: #f99b15 } /* Literal.Number.Float */
pre.code .mh { color: #f99b15 } /* Literal.Number.Hex */
pre.code .mi { color: #f99b15 } /* Literal.Number.Integer */
pre.code .mo { color: #f99b15 } /* Literal.Number.Oct */
pre.code .sa { color: #48b685 } /* Literal.String.Affix */
pre.code .sb { color: #48b685 } /* Literal.String.Backtick */
pre.code .sc { color: #e7e9db } /* Literal.String.Char */
pre.code .dl { color: #48b685 } /* Literal.String.Delimiter */
pre.code .sd { color: #776e71 } /* Literal.String.Doc */
pre.code .s2 { color: #48b685 } /* Literal.String.Double */
pre.code .se { color: #f99b15 } /* Literal.String.Escape */
pre.code .sh { color: #48b685 } /* Literal.String.Heredoc */
pre.code .si { color: #f99b15 } /* Literal.String.Interpol */
pre.code .sx { color: #48b685 } /* Literal.String.Other */
pre.code .sr { color: #48b685 } /* Literal.String.Regex */
pre.code .s1 { color: #48b685 } /* Literal.String.Single */
pre.code .ss { color: #48b685 } /* Literal.String.Symbol */
pre.code .bp { color: #e7e9db } /* Name.Builtin.Pseudo */
pre.code .fm { color: #06b6ef } /* Name.Function.Magic */
pre.code .vc { color: #ef6155 } /* Name.Variable.Class */
pre.code .vg { color: #ef6155 } /* Name.Variable.Global */
pre.code .vi { color: #ef6155 } /* Name.Variable.Instance */
pre.code .vm { color: #ef6155 } /* Name.Variable.Magic */
pre.code .il { color: #f99b15 } /* Literal.Number.Integer.Long */

</style>
</head>
<body>
<div class="document" id="let-s-talk-with-a-bit-of-theory">
<h1 class="title">Let's talk with a bit of theory</h1>

<p>Deep (down) inside the Linux Kernel, there's a framework called <strong>netfilter</strong>.
Every IP packet that flows through the machine is subjected to critical
examination by Netfiler. It basically observes:</p>
<ul class="simple">
<li><p>Source IP Address of the packet</p></li>
<li><p>Destination IP Address of the packet</p></li>
<li><p>The overlying protocol (UDP or TCP)</p></li>
<li><p>Source Port</p></li>
<li><p>Destination Port</p></li>
<li><p>From which Network Interface the packet came in</p></li>
<li><p>To which Network Interface the packet is going out</p></li>
<li><p>Other stuff (e.g. TCP flags, TCP Headers)</p></li>
</ul>
<p>Based on the examination, there's a set of rules we define, so <em>Netfilter</em>
decides either to accept a packet, meaning to allow it to pass or to drop it.
This filtering occurs as the number of places the packet flows inside the
machine. For example:</p>
<p>Let's say we have a packet coming in. The first that happens is a routing
decision: Is the packet destined for the local machine, or not? If it does, then
it passes through the <strong>INPUT</strong> chain, where we keep a list of filtering rules.
Assuming that the package complies with the list of rules, it survives our
filtering and passes onto a <strong>local process</strong>, presumably listening on a TCP/UDP
port.</p>
<p>If the packet is destined for another machine, it will pass through the
<strong>FORWARD chain</strong>, and then into another list of filtering rules and last gets
transmitted back to the network. If the packet originates on the local machine,
it will pass through the <strong>OUTPUT chain</strong>, before being send out to the network.</p>
<p>A chain, is basically a list of rules. Each rule is consisted of a pattern and
an associated action. This looks like a stack of rules, that order matters. So,
the first rule that gets matched, determines the fate of the packet, meaning
that an associated action will be applied on it. An associated action normaly is
either accept or drop the packet. However, if the packet doesn't match any rule
and makes its way down to the end of the chain, then there's a policy that it's
also applied on that chain, so a default action will be taken. All of these
rules are down inside the kernel, but in <strong>userspace</strong> there's a command-line
tool, called <strong>iptables</strong> that's responsible for managing these rules in the
kernel. And essentially, what we are going to do in this tutorial is to create
a very simply shell script containing iptables' commands that will allow our
machine to operate as a simple firewall.</p>
<div class="section" id="setup">
<h1>Setup</h1>
<p>The setup we are using for this demo, is a <strong>Server machine</strong> which runs SSH
Server, Web Server and a couple of other things. From the other hand, I have a
client machine that will allow me to observe the server machine from outside.
Also, just to make our life a little less confusing, we are going to use pink
color for the terminal in the server machine, and green color for the client
one.</p>
<div class="section" id="look-at-the-current-ruleset">
<h2>Look at the current ruleset</h2>
<p>Let's start by going to the server machine and looking and the current ruleset.</p>
<pre class="code bash literal-block"><code><span class="c1"># iptables -L
</span>
Chain INPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain FORWARD <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination

Chain OUTPUT <span class="o">(</span>policy ACCEPT<span class="o">)</span>
target     prot opt <span class="nb">source</span>               destination</code></pre>
<p>What we see here is that no matter of the chains, there are no rules at the
moment being specified. Also, in each of the chains, the default policy is to
ACCEPT the packet. So, currently everything is allowed to flow in, without any
kind of filtering taking place.</p>
<p>So, let's go now to our client machine and try to do an SSH login.</p>
<pre class="code bash literal-block"><code>ssh root&#64;server</code></pre>
<p>As you can see, we were able to connect via SSH into the machine as a proof that
nothing prevented us from doing it so. Apart from SSH, there's also another tool
we case use, called nmap. Nmap is a port-scanner and can tell us which port is
open and which port is closed on the server. So, let's do a port scann of the
server:</p>
<pre class="code bash literal-block"><code>nmap -PN server

Starting Nmap <span class="m">6</span>.47 <span class="o">(</span> http://nmap.org <span class="o">)</span> at <span class="m">2016</span>-11-28 <span class="m">23</span>:40 CET
Nmap scan report <span class="k">for</span> localhost <span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span>
Host is up <span class="o">(</span><span class="m">0</span>.000017s latency<span class="o">)</span>.
Not shown: <span class="m">996</span> closed ports
PORT    STATE SERVICE
<span class="m">22</span>/tcp  open  ssh
<span class="m">25</span>/tcp  open  smtp
<span class="m">80</span>/tcp  open  http
<span class="m">111</span>/tcp open  rpcbind
<span class="m">631</span>/tcp open  ipp</code></pre>
</div>
</div>
</div>
</body>
</html>
