<!DOCTYPE html>
<html lang="en">
<head>
  
    <title> :: Terminal</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="When we are writing unit tests, we want to make sure that our unit works as expected. Simple put, for a given input it returns an expected output. Most of the tutorials are showing very simple examples (for a good reason) where there is a function that receives two integers and returns the sum of them. In that case, the programmer writes a unit test by adding two hardcoded examples, one that passes and one that is expected to fail (to test the error logging mechanism, if it exists)." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/mock/" />




<link rel="stylesheet" href="/assets/style.css">






<link rel="apple-touch-icon" href="/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="">
<meta property="og:description" content="When we are writing unit tests, we want to make sure that our unit works as expected. Simple put, for a given input it returns an expected output. Most of the tutorials are showing very simple examples (for a good reason) where there is a function that receives two integers and returns the sum of them. In that case, the programmer writes a unit test by adding two hardcoded examples, one that passes and one that is expected to fail (to test the error logging mechanism, if it exists)." />
<meta property="og:url" content="/post/mock/" />
<meta property="og:site_name" content="Terminal" />

  
    <meta property="og:image" content="/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">













</head>
<body class="orange">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/showcase">Showcase</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/post/mock/"></a></h1>
  <div class="post-meta">
    
    
  </div>

  

  

  

  <div class="post-content"><div>
        <p>When we are writing unit tests, we want to make sure that our <strong>unit</strong> works as expected. Simple put, for a given input it returns an expected output. Most of the tutorials are showing very simple examples (for a good reason) where there is a function that receives two integers and returns the sum of them. In that case, the programmer writes a unit test by adding two hardcoded examples, one that passes and one that is expected to fail (to test the error logging mechanism, if it exists). In this blogpost, I&rsquo;ll take a look at more realistic examples, where the function under test relies on another function which you have no control. That usually happens when you are using external services, like communicating with an API or a web service or many other things. The important point is that your test can&rsquo;t control what that dependency returns back to your function or how it behaves. There are many things can go wrong here, the network, the external service system, and many other things. So, I will use <em>mocking</em> techniques to <strong>simulate</strong> both an expected and an unexpected behavior of this external dependency.</p>
<h3 id="what-is-an-external-dependency">What is an external dependency<a href="#what-is-an-external-dependency" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>An <strong>external dependency</strong> is an object in your system that your code under test interacts with and over which you have no control. Common examples are filesystems, memory, time, network connectivity, and so on.</p>
<h3 id="what-is-a-stub">What is a stub<a href="#what-is-a-stub" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>A <strong>stub</strong> is a controllable replacement for an existing dependency in the system. In programming, you use <strong>stubs</strong> to get around around the problem of external dependencies. By using a system, you can test your code without dealing with the dependency directly.</p>
<h3 id="how-to-test">How to test<a href="#how-to-test" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>So you can&rsquo;t test something? Add a layer that wraps the calls to that comething, and then mimic that layer in your tests. Let&rsquo;s say the function you want to test (but you cannot control) it is called <code>UserExists()</code> which registeres a user if not registered already to an external database.</p>
<blockquote>
<p>Notice that we have to always test our public/exported functions.</p>
</blockquote>
<ul>
<li>Create an interface that the object under test works against.</li>
<li>Replace the underlying implementation of that interface with something you have control over.</li>
</ul>
<h2 id="lets-write-a-client-for-github">Lets write a client for Github<a href="#lets-write-a-client-for-github" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>I will write a client that authenticates myself with Github API and then fetches the description of my &ldquo;ghostfish&rdquo; repository.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/google/go-github/v30/github&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/oauth2&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// Import your GitHub token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">Token</span>{
		<span style="color:#a6e22e">AccessToken</span>: <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;GHTOKEN&#34;</span>),
	}
	<span style="color:#a6e22e">tokenSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">StaticTokenSource</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">token</span>)

	<span style="color:#75715e">// Construct oAuth2 client with GitHub token
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">tokenSource</span>)

	<span style="color:#75715e">// Construct a GitHub client passing the oAuth2 client
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">tc</span>)

	<span style="color:#75715e">// Fetch information about the https://github.com/drpaneas/ghostfish repository
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Repositories</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;drpaneas&#34;</span>, <span style="color:#e6db74">&#34;ghostfish&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">// Print the description of the repository
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetDescription</span>())
}
</code></pre></div><p>So far, nothing is being mocked. To run the code above you will need a pair of <a href="https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line">GitHub&rsquo;s Token</a> loaded into an environment variable:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">$ export GHTOKEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;your token&#34;</span>
</code></pre></div><p>Running it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">$ go build
$ ./gh-client
A TCP Scanner written in Go
</code></pre></div><h2 id="separation-of-concerns">Separation of concerns<a href="#separation-of-concerns" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Having everything into a single <code>main()</code> function is quite hard to write good unit-tests. A call to <code>main()</code> in the test will do multiple network requests to GitHub&rsquo;s API, which is not what we intend to do. Let&rsquo;s break the code apart:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/google/go-github/v30/github&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/oauth2&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewGithubClient</span>()
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">client</span>, <span style="color:#e6db74">&#34;drpaneas&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error&#34;</span>)
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetDescription</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewGithubClient</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Client</span> {
	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">Token</span>{
		<span style="color:#a6e22e">AccessToken</span>: <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;GHTOKEN&#34;</span>),
	}
	<span style="color:#a6e22e">tokenSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">StaticTokenSource</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">token</span>)
	<span style="color:#a6e22e">tc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">tokenSource</span>)
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">tc</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Repositories</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">user</span>, <span style="color:#e6db74">&#34;ghostfish&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>Better! Two distinct functions were defined:</p>
<ul>
<li><code>NewGithubClient()</code> authenticates and returns a client to be used in subsequent operations, like getting the list of repositories.</li>
<li><code>GetUserRepo()</code> gets the user&rsquo;s repository</li>
</ul>
<p><strong>Notice</strong>: The <code>GetUserRepo()</code> accepts a <code>*github.Client</code> to do the GitHub request, this is the beginning of the dependency injection pattern. The client is being <em>injected</em> into the function that will use it. Could we inject a <em>mock</em> one? Before answering this question, take a look at this simple test:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// main_test.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main_test</span>

<span style="color:#f92672">import</span> (
	. <span style="color:#e6db74">&#34;github.com/drpaneas/gh-client&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
	<span style="color:#e6db74">&#34;testing&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestGetUserRepos</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Setenv</span>(<span style="color:#e6db74">&#34;GHTOKEN&#34;</span>, <span style="color:#e6db74">&#34;fake token&#34;</span>)
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewGithubClient</span>()
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">client</span>, <span style="color:#e6db74">&#34;whatever&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Expected nil, got %s&#34;</span>, <span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetDescription</span>() <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;A TCP Scanner written in Go&#34;</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;extected &#39;A TCP Scanner written in Go&#39;, got %s&#34;</span>, <span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetDescription</span>())
	}

}
</code></pre></div><p>Run it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">$ go test
--- FAIL: TestGetUserRepos <span style="color:#f92672">(</span>1.77s<span style="color:#f92672">)</span>
    main_test.go:14: Expected nil, got GET https://api.github.com/repos/whatever/ghostfish: <span style="color:#ae81ff">401</span> Bad credentials <span style="color:#f92672">[]</span>
    main_test.go:18: extected <span style="color:#e6db74">&#39;A TCP Scanner written in Go&#39;</span>, got <span style="color:#e6db74">&#39;&#39;</span>
FAIL
exit status <span style="color:#ae81ff">1</span>
FAIL    github.com/drpaneas/gh-client   3.896s
</code></pre></div><p>The program returns an error, trying to authenticate with our fake <code>GHTOKEN</code> . We don&rsquo;t want that.</p>
<h2 id="interfaces-to-the-rescue">Interfaces to the rescue<a href="#interfaces-to-the-rescue" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Imagine we could create a mock for <code>*github.Client</code> with the same <code>Repositories.Get()</code> method and signature and inject it into the <code>GetUserRepo()</code> method during the test. Go is statically typed language and with the current implementation only <code>*github.Client</code> can be passed into <code>GetUserRepo()</code>. Thus, it needs to be refactored to accept <strong>any type</strong> with a <code>Repositories.Get()</code>, like a mock client.</p>
<p>Fortunately, Go has the concept of <code>interface</code> which is a type with a set of metho signatures. If <em>any type</em> implements those methods, it <em>satisfies</em> the interface and be recognized by the interface&rsquo;s type. Now this situation is a a little bit <em>tricky</em> because the <code>Get</code> function is on a <code>Repositories</code> field in the <code>*github.Client</code>, not directly on the client. As a result, instead of creating a mock for the <code>github.Client</code> with the same <code>Repositories.Get()</code> function (as I said in the beginning), I will create a mock for the <code>github.Client.Repositories</code> field with the same <code>Get()</code> method. Doing this, I would have to change the code a bit first. Simply put, my target goal is to simulate this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- repo, _, err := client.Repositories.Get(context.Background(), user, &#34;ghostfish&#34;)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+ repo, _, err := &lt;interface&gt;.Get(context.Background(), user, &#34;ghostfish&#34;)
</span></code></pre></div><p>Here&rsquo;s the code changes needed to be done:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Change the call by passing the `.Repositories` of the `client`, instead of the whole `client` itself.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Repositories</span>, <span style="color:#e6db74">&#34;drpaneas&#34;</span>)

<span style="color:#75715e">// Change the GetUserRepo() to accept the correct type
</span><span style="color:#75715e">// call the Get() function from this type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">repos</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">RepositoriesService</span>, <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repos</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">user</span>, <span style="color:#e6db74">&#34;ghostfish&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><p>Great! Now let&rsquo;s fix the test accordingly:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- 	repo, err := GetUserRepo(client, &#34;whatever&#34;)
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+   repo, err := GetUserRepo(client.Repositories, &#34;whatever&#34;)
</span></code></pre></div><p>The code build and runs perfectly fine &ndash; the same as before &ndash; but the test is still failing with the same error. That is fine, because now we are using calling the <code>Get()</code> function in a <code>A.Get()</code> style, instead of <code>A.B.Get()</code>. Meaning, we need to just create an <code>A</code> interface that has a <code>Get()</code> function. This is our interface below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Repositories</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Get</span> (<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>)
}
</code></pre></div><p>Now the only change needed is to <em>replace</em> the usage of <code>repos.Get()</code> to be from our <code>Repositories</code> interface instead of the 3rd party library <code>*github.RepositoriesService</code>. To do that, we simply do this change in the signature of the <code>GetUserRepo()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- func GetUserRepo(repos *github.RepositoriesService, user string) (*github.Repository, error) {
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+ func GetUserRepo(repos Repositories, user string) (*github.Repository, error) {
</span></code></pre></div><p>So the final code including all the changes, looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;github.com/google/go-github/v30/github&#34;</span>
	<span style="color:#e6db74">&#34;golang.org/x/oauth2&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;os&#34;</span>
)

<span style="color:#75715e">// 1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Repositories</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Get</span> (<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewGithubClient</span>()
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Repositories</span>, <span style="color:#e6db74">&#34;drpaneas&#34;</span>)   <span style="color:#75715e">// 2
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error&#34;</span>)
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">GetDescription</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewGithubClient</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Client</span> {
	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">Token</span>{
		<span style="color:#a6e22e">AccessToken</span>: <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;GHTOKEN&#34;</span>),
	}
	<span style="color:#a6e22e">tokenSource</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">StaticTokenSource</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">token</span>)
	<span style="color:#a6e22e">tc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">oauth2</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">tokenSource</span>)
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">tc</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>
}

<span style="color:#75715e">// 3
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetUserRepo</span>(<span style="color:#a6e22e">repos</span> <span style="color:#a6e22e">Repositories</span>, <span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">repos</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">user</span>, <span style="color:#e6db74">&#34;ghostfish&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">repo</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><ul>
<li>1: Creates the interface with the name of the <em>field</em> called <code>Repositories</code> with the same <code>Get()</code> signature from <code>*github.Client</code>.</li>
<li>2: Change the call by passing the <code>.Repositories</code> of the <code>client</code>, instead of the whole <code>client</code> itself.</li>
<li>3: Change the signature to use the Interface instead of the 3rd party library <code>github.com/google/go-github/v30/github</code></li>
</ul>
<p>The code builds and run as expected and the tests are still failing with the same error as before. So, you might wonder <strong>what is the difference now?</strong>. Well, that is a very good question and if you can answer it, it means you have understood the topic of this article. Before, the code was using <strong>directly</strong> the <code>Get()</code> function from <code>github.com/google/go-github/v30/github</code>. Now, the code is <em>still</em> uses this function (we cannot avoid this of course), but <strong>indirectly</strong>. The <code>Get()</code> function is now talking to our interface, and our interface is providing its output by calling the <em>actual</em> function behind-the-scenes.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Before
</span><span style="color:#75715e"></span><span style="color:#a6e22e">GetUserRepo</span>() <span style="color:#f92672">--</span>&gt; <span style="color:#ae81ff">3</span><span style="color:#a6e22e">rd</span> <span style="color:#a6e22e">Party</span> <span style="color:#a6e22e">depedency</span>

<span style="color:#75715e">// After
</span><span style="color:#75715e"></span><span style="color:#a6e22e">GetUserRepo</span>() <span style="color:#f92672">--</span>&gt; <span style="color:#a6e22e">Interface</span> <span style="color:#f92672">--</span>&gt; <span style="color:#ae81ff">3</span><span style="color:#a6e22e">rd</span> <span style="color:#a6e22e">Party</span> <span style="color:#a6e22e">dependency</span>
</code></pre></div><p>Did you understand the difference a bit better now? Yet, there is a new question lying around this time: <strong>why we did this? what is the benefit?</strong>. This is the next best question you should ask, and is the last one (I promise). Remember the original problem? Writing a test that is <em>not using the 3rd party library</em>. Our test is still using it though, and it fails because we pass it fake ID tokens. But now, we can actually fix this once and for all.</p>
<p>Now, we can create a mock struct simulating behavior of the original <code>Get()</code> function. To do that, we will use a little help from the <a href="https://github.com/golang/mock">GoMock</a> framework. You need to install it first:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// You need a new Go version that works with Go modules
</span><span style="color:#75715e"></span><span style="color:#a6e22e">GO111MODULE</span>=<span style="color:#a6e22e">on</span> <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">golang</span><span style="color:#f92672">/</span><span style="color:#a6e22e">mock</span><span style="color:#f92672">/</span><span style="color:#a6e22e">mockgen</span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">latest</span>
</code></pre></div><p>We use <code>mockgen</code> to generate our mocking implementation of our interface:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">$ mockgen <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -source<span style="color:#f92672">=</span>main.go <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -destination<span style="color:#f92672">=</span>mocks/mock_repositories.go <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -package<span style="color:#f92672">=</span>$GOPACKAGE
</code></pre></div><p>This will generate a new file <code>mock_repositories.go</code> under a new folder <code>mocks</code> that looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Code generated by MockGen. DO NOT EDIT.
</span><span style="color:#75715e">// Source: main.go
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Package mock_main is a generated GoMock package.
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">mock_main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#a6e22e">context</span> <span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#a6e22e">gomock</span> <span style="color:#e6db74">&#34;github.com/golang/mock/gomock&#34;</span>
	<span style="color:#a6e22e">github</span> <span style="color:#e6db74">&#34;github.com/google/go-github/v30/github&#34;</span>
	<span style="color:#a6e22e">reflect</span> <span style="color:#e6db74">&#34;reflect&#34;</span>
)

<span style="color:#75715e">// MockRepositories is a mock of Repositories interface
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MockRepositories</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ctrl</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">gomock</span>.<span style="color:#a6e22e">Controller</span>
	<span style="color:#a6e22e">recorder</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositoriesMockRecorder</span>
}

<span style="color:#75715e">// MockRepositoriesMockRecorder is the mock recorder for MockRepositories
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MockRepositoriesMockRecorder</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">mock</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositories</span>
}

<span style="color:#75715e">// NewMockRepositories creates a new mock instance
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMockRepositories</span>(<span style="color:#a6e22e">ctrl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">gomock</span>.<span style="color:#a6e22e">Controller</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositories</span> {
	<span style="color:#a6e22e">mock</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MockRepositories</span>{<span style="color:#a6e22e">ctrl</span>: <span style="color:#a6e22e">ctrl</span>}
	<span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">recorder</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">MockRepositoriesMockRecorder</span>{<span style="color:#a6e22e">mock</span>}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mock</span>
}

<span style="color:#75715e">// EXPECT returns an object that allows the caller to indicate expected use
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositories</span>) <span style="color:#a6e22e">EXPECT</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositoriesMockRecorder</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">recorder</span>
}

<span style="color:#75715e">// Get mocks base method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">m</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositories</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Response</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">T</span>.<span style="color:#a6e22e">Helper</span>()
	<span style="color:#a6e22e">ret</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">m</span>, <span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span>)
	<span style="color:#a6e22e">ret0</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ret</span>[<span style="color:#ae81ff">0</span>].(<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Repository</span>)
	<span style="color:#a6e22e">ret1</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ret</span>[<span style="color:#ae81ff">1</span>].(<span style="color:#f92672">*</span><span style="color:#a6e22e">github</span>.<span style="color:#a6e22e">Response</span>)
	<span style="color:#a6e22e">ret2</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ret</span>[<span style="color:#ae81ff">2</span>].(<span style="color:#66d9ef">error</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret0</span>, <span style="color:#a6e22e">ret1</span>, <span style="color:#a6e22e">ret2</span>
}

<span style="color:#75715e">// Get indicates an expected call of Get
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">mr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositoriesMockRecorder</span>) <span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">gomock</span>.<span style="color:#a6e22e">Call</span> {
	<span style="color:#a6e22e">mr</span>.<span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">T</span>.<span style="color:#a6e22e">Helper</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">mr</span>.<span style="color:#a6e22e">mock</span>.<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">RecordCallWithMethodType</span>(<span style="color:#a6e22e">mr</span>.<span style="color:#a6e22e">mock</span>, <span style="color:#e6db74">&#34;Get&#34;</span>, <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>((<span style="color:#f92672">*</span><span style="color:#a6e22e">MockRepositories</span>)(<span style="color:#66d9ef">nil</span>).<span style="color:#a6e22e">Get</span>), <span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">owner</span>, <span style="color:#a6e22e">repo</span>)
}
</code></pre></div><p>This means, we can <em>import</em> this file in our tests &ndash; instead of the 3rd party library:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- . &#34;github.com/drpaneas/gh-client&#34;
</span></code></pre></div>
      </div></div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2021 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>







  
</div>

</body>
</html>
